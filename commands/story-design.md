# Story Design - 整合式專案設計系統

為軟體開發專案提供**從專案啟動到技術設計的完整解決方案**，整合專案規劃、User Story 挖掘、系統分析與架構設計，採用**漸進式發現**方法，確保專案目標與技術方案完全一致。

**🚨 重要**: 此命令提供一站式服務，從專案啟動到技術實作的完整流程。純技術優化請使用 `/analysis-plan` 和 `/design-plan`。

## 使用方式
```bash
/story-design "設計任務描述" [可選：PROMPT檔案路徑]
```

---

## 🎯 核心概念：OpenSpec 行為規範

### OpenSpec 是什麼？

OpenSpec 是一個**AI 行為規範系統**，幫助 AI 進行系統化的分析和設計思考。

**🎯 核心定位**：
- **思考框架**：幫助 AI 進行系統化分析的行為指導
- **品質保證**：確保不遺漏關鍵分析步驟的驗證機制
- **漸進式發現**：通過確認點確保方向正確

**❌ 不是什麼**：
- **文檔格式模板**：不應該成為最終文檔的格式要求
- **產出格式標準**：不應該規定最終產出要用什麼格式

### 4-Stage 行為規範

基於 OpenSpec 的漸進式發現方法論，確保每個決策點都經過確認：

#### **SD1: 專案探索** (Project Discovery)
- **行為要求**: 專案總體規劃 + User Story 深度挖掘
- **關鍵確認點**: 專案目標、核心價值、執行策略確認
- **驗證標準**: 確認繼續進入 SD2 的意願

#### **SD2: 系統分析** (System Analysis)
- **行為要求**: 現有系統理解 + DFD/ERD 分析 + 技術可行性評估
- **關鍵確認點**: 系統理解正確性、分析範圍適當性確認
- **驗證標準**: 確認繼續進入 SD3 的意願

#### **SD3: 架構設計** (Architecture Design)
- **行為要求**: 系統架構設計 + 技術方案制定 + Pseudo Code 設計
- **關鍵確認點**: 技術方案可行性、架構設計正確性
- **驗證標準**: 確認繼續進入 SD4 的意願

#### **SD4: 最終確認** (Final Confirmation)
- **行為要求**: 完整方案確認 + 段落式實作規劃
- **關鍵確認點**: 方案完整性、實作可行性
- **驗證標準**: 所有 4 個確認點通過，execution-plan 就緒

### 🚨 關鍵確認機制

**強制執行規則**：
1. **禁止跳過確認點**：任何情況下都不得跳過 SD1-SD4 的關鍵確認點
2. **用戶確認優先**：必須獲得用戶明確確認才能進入下一階段
3. **方向調整機制**：基於用戶回饋立即調整分析和設計方向

**確認語言標準**：
```
基於我們的討論，這是 [階段名稱] 的分析/設計結果：

**核心發現**: [列出主要發現]
**技術決策**: [列出關鍵決策]
**下一階段**: [說明下一步行動]

請確認：
1. 這個 [階段名稱] 結果是否符合您的期望？
2. 可以繼續進入 [下一階段] 嗎？
```

---

## 🎭 角色定位與專業範圍

### **適用情境** (何時使用此命令)

**✅ 適用情境**:
- **新專案啟動**: 需要完整規劃和技術設計的新專案
- **複雜功能開發**: 需要深度規劃和技術實現的複雜功能
- **系統重構**: 需要全面評估和重新設計的系統重構
- **業務轉型**: 需要技術支援的業務變革項目

**❌ 不適用情境**:
- **純技術優化**: 沒有明確專案目標的技術改進
- **緊急修復**: 需要快速解決的技術問題
- **小型功能**: 簡單功能可直接使用其他命令

### **核心角色分工**

#### **SD1-SD4 設計流程** (OpenSpec 行為規範)
- **主導角色**: AI 系統設計師
- **行為模式**: 漸進式發現 + 關鍵確認點
- **交付成果**: 系統化分析設計文檔

#### **execution-plan 銜接** (基於 SD1-SD4 成果)
- **主導角色**: AI 實作規劃師
- **行為模式**: 智能段落劃分 + Self-Contained 設計
- **交付成果**: 段落式實作計畫書

---

## 📚 專業知識庫 (強制自動載入)

🚨 **必須按順序載入以下核心文檔**：
1. CLAUDE.md - 基礎行為準則與環境約束
2. session_notes.md - 當前任務狀態
3. [可選] docs/ai_support/core/architect_comprehensive_guide.md - SD1-SD4 方法論指導

---

## 📋 執行流程與行為指導

### **完整的 4-Stage 執行流程**

```
SD1: 專案探索 → 關鍵確認點 → SD2: 系統分析
      ↓                                    ↓
   User Story 挖掘                        系統理解分析
   價值主張定義                          DFD/ERD 設計
      ↓                                    ↓
SD3: 架構設計 → 關鍵確認點 → SD4: 最終確認
      ↓                                    ↓
   系統架構設計                          方案完整性驗證
   Pseudo Code 設計                      段落式實作規劃
      ↓                                    ↓
execution-plan 就緒 → 交付設計文檔 → 開始實作
```

### **行為指導原則**

#### **1. Understanding-First 原則**
- **行為要求**: 深度理解優先於設計重構
- **執行方式**: SA 分析 → SD 設計 → 實作
- **驗證機制**: 每個階段都有理解確認點

#### **2. 查證優先原則**
- **行為要求**: 基於實際代碼查證，不憑經驗推測
- **執行方式**: 預列清單 → 用戶確認 → 批量讀取 → 分析報告
- **來源標記**: 每個結論都標註檔案路徑和行號

#### **3. 關鍵確認原則**
- **行為要求**: 每個階段都必須獲得用戶確認
- **執行方式**: 呈現分析結果 → 詢問確認 → 記錄決策
- **禁止行為**: 跳過確認點、假設用戶意圖

#### **4. Examples-Driven 原則**
- **行為要求**: 可執行範例驗證功能理解正確性
- **執行方式**: 設計 Examples → 執行驗證 → 用戶確認
- **驗證標準**: Examples 能正常運行且符合預期

---

## 🏗️ SD1-SD4 詳細行為規範

### **SD1: 專案探索行為規範**

#### **核心行為要求**
- **專案總體規劃**: 明確專案目標、範圍、成功標準
- **User Story 深度挖掘**: 理解用戶背景、痛點、期望
- **執行策略制定**: 規劃 SD2-SD4 的具體實施路徑

#### **關鍵確認點**
- 專案目標和價值主張是否明確？
- User Story 分析是否深入準確？
- 執行策略是否可行？

#### **交付標準**
- 完整的專案概要和 User Story 分析
- 清晰的技術策略和執行計畫
- 用戶確認進入 SD2 的意願

### **SD2: 系統分析行為規範**

#### **🚨 預查證清單機制** (Context效率優化)
**執行流程**: 分析前先提出查證清單 → 用戶確認 → 批量讀取 → 開始分析

##### **查證清單生成原則**
- **核心檔案優先**: 識別3-5個最關鍵的實作檔案
- **使用模式查證**: 優先尋找相關examples，若無則查證測試檔案或實際調用代碼
- **配置和依賴**: 識別關鍵配置檔案和import依賴關係
- **彈性調整**: 根據實際專案狀況調整查證範圍

##### **查證清單確認機制**
**執行原則**：
- **禁止基於經驗推測**: 任何架構、API、流程分析必須有檔案證據
- **明確標記來源**: 每個結論註明來源檔案和具體代碼片段 (如函數名、類名、關鍵邏輯)
- **區分已知未知**: 明確區分「已查證」vs「待查證」vs「推測」
- **批量讀取效率**: 用戶確認後一次性讀取，避免重複context使用

#### **核心行為要求**
- **現有系統深度分析**: DFD、ERD、功能分解
- **技術可行性評估**: 基於實際代碼的可行性分析
- **整合點識別**: 識別與現有系統的整合方式

#### **關鍵確認點**
- 系統理解是否準確完整？
- 技術可行性評估是否客觀？
- 整合策略是否可行？

#### **交付標準**
- 完整的 DFD、ERD、功能分解圖
- 技術可行性評估報告
- 用戶確認進入 SD3 的意願

### **SD3: 架構設計行為規範**

#### **核心行為要求**
- **系統架構設計**: 基於 SD2 分析結果的架構設計
- **技術方案制定**: 具體可執行的技術實作方案
- **Pseudo Code 設計**: 詳細的程式結構設計藍圖

#### **🏗️ Pseudo Code 設計標準**
1. **方法簽名設計**: 完整的參數類型、返回值定義
2. **設計意圖註釋**: 詳細說明業務邏輯和架構考量
3. **Call Stack展示**: 展示函數調用關係和執行路徑
4. **架構決策記錄**: 設計原因和技術考量說明

#### **檔案結構展示方式**
使用類似檔案樹的方式展示，而非抽象的mermaid圖表：
```
[project_name]/
├── [module_name]/
│   ├── core_class.py              # 核心系統組件
│   ├── feature_a.py                # 功能組件 A
│   └── feature_b.py                # 功能組件 B
```

#### **關鍵確認點**
- 架構設計是否解決識別的問題？
- 技術方案是否可行且最佳？
- Pseudo Code 是否提供足夠的實作指導？

#### **交付標準**
- 完整的系統架構圖和模組結構
- 詳細的 Pseudo Code 設計藍圖
- 用戶確認進入 SD4 的意願

### **SD4: 最終確認行為規範**

#### **核心行為要求**
- **完整方案確認**: 驗證 SD1-SD3 設計的完整性和一致性
- **段落式實作規劃**: 為 execution-plan 提供實作指導
- **品質保證檢查**: 確保設計方案的可執行性

#### **execution-plan 準備資訊**
- **關鍵檔案影響分析**: 識別需要修改/新增的檔案
- **實作模板基礎**: 提供核心類別結構和 API 介面設計
- **段落劃分建議**: 基於設計複雜度的段落式實作建議

#### **關鍵確認點**
- 整體方案是否完整一致？
- 實作計劃是否詳細可行？
- 是否準備好進入 execution-plan？

#### **交付標準**
- 完整的技術設計方案
- 詳細的實作規劃和檢查清單
- 用戶確認 execution-plan 就緒

---

## 📝 交付物標準

### **單一 Story Design 文檔**
- **✅ 必須產生**: 單一完整的設計文檔
- **❌ 禁止產出**: 多個分散的分析、設計文檔
- **📁 文檔命名**: `[project_name]_story_design.md`
- **📍 文檔位置**: `docs/design/` 目錄

### **SD1-SD4 完整內容要求**
- **包含 SA 分析**: 系統理解、DFD、ERD、功能分解
- **包含 SD 設計**: 系統架構、模組結構、Pseudo Code、介面規範
- **包含確認記錄**: 4 個關鍵確認點的完整記錄
- **execution-plan 就緒**: 確認包含實作所需的所有資訊

### **品質驗證機制**
- **SA/SD 一致性**: 確保系統分析與架構設計一致
- **User Story 貫穿**: 確保 User Story 貫穿整個設計過程
- **技術可行性**: 確保設計方案可實際執行
- **整合準備**: 確認能夠支撐 execution-plan

---

## 🚀 與其他命令的整合

### **執行鏈路**
```
/story-design → /execution-plan → /impl
```

### **命令分工**
- **/story-design**: SD1-SD4 完整設計流程，系統化分析與架構設計
- **/execution-plan**: 基於設計成果進行段落式實作規劃
- **/impl**: 執行具體的功能實作，Examples 驅證開發

### **協作模式**
- **前置依賴**: execution-plan 必須基於 story-design 的 SD1-SD4 成果
- **後續支撐**: /impl 執行時可以參考完整的設計文檔
- **品質保證**: 3 個命令形成完整的設計-規劃-實作閉環

---

## 📚 成功案例與最佳實踐

### **成功案例特徵**
- **用戶驅動**: 深度理解用戶需求和痛點
- **技術可行**: 設計方案基於實際系統分析
- **確認充分**: 每個關鍵決策點都有用戶確認
- **執行就緒**: 設計文檔包含 execution-plan 所需的所有資訊

### **最佳實踐總結**
- **4-Stage 不可跳過**: 確保每個階段的充分分析和確認
- **查證優先**: 基於實際代碼進行分析，不憑經驗推測
- **User Story 核心**: 所有技術決策都回歸到用戶故事
- **品質保證**: 確保設計方案的完整性和可行性

## 🔧 輸出和後續行動

### **直接輸出**
1. **設計文檔路徑**: 提供完整的 Story Design 檔案位置
2. **SD1-SD4 成果摘要**: 各階段的關鍵發現和技術決策
3. **執行策略**: 整體實作規劃和優先級建議
4. **execution-plan 準備**: 段落式實作所需的所有資訊

### **後續行動建議**
- **開始實作規劃**: 使用 `/execution-plan` 基於 SD1-SD4 成果生成段落式實作計畫書
- **團隊協作**: 根據設計結果分配開發任務和責任
- **持續驗證**: 在實作過程中持續驗證設計假設
- **文檔維護**: 實作過程中同步更新設計文檔

### **設計品質提醒**
- **SD1-SD4 完整性**: 確保所有 4 個階段都有充分分析和確認
- **用戶確認記錄**: 保留所有關鍵確認點的完整記錄
- **技術可行性**: 確保設計方案基於實際系統分析
- **執行就緒**: 確認設計結果能夠支撐 execution-plan

---

**重要**: 此命令提供從專案啟動到技術設計的完整解決方案。純技術優化請使用 `/analysis-plan` 和 `/design-plan`。

**🚨 強制要求**:
- **4-Stage 不可跳過**: 必須完成 SD1-SD4 所有階段的分析和確認
- **🏗️ 必須產生單一設計文檔**：包含所有 SD1-SD4 成果
- **🚨 關鍵確認機制**: 必須獲得用戶明確確認才能進入下一階段
- **🚨 預查證清單**: 必須基於實際代碼查證，禁止經驗推測
- **🚨 Pseudo Code 設計**: 必須包含完整的程式結構設計藍圖
- **🚨 execution-plan 就緒**: 確認包含實作所需的所有資訊
- **品質保證機制**: 必須包含 SA/SD 一致性驗證

**最後更新**: 2025-10-26
**文檔版本**: v2.0 - OpenSpec 行為規範導向版本
**核心改進**: 澄清 OpenSpec 作為 AI 行為規範的定位，恢復所有專業設計細節
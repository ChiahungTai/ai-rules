# /lessons 命令設計文檔

## 🎯 目標

從對話歷史中提取目錄的程式碼精隨，生成 CLAUDE.md，讓 AI 不用讀取所有程式碼就能快速理解模組用途和重要實作細節。

---

## 📋 核心概念

### 什麼應該被提取？

#### ✅ 應該提取
- **模組用途** - 這個目錄做什麼？核心功能是什麼？
- **目錄結構** - 重要檔案和子目錄的組織方式
- **核心 API/Class** - 主要類別和函數的用途描述
- **設計決策** - 為什麼這樣設計？選擇了什麼方案？
- **重要實作細節** - 有什麼特殊實作？需要注意什麼？
- **模組間關係** - 跟其他模組如何互動？依賴什麼？
- **常見陷阱** - 這個模組容易犯什麼錯誤？

**🤖 AI 價值強調**: 對於 AI 協作開發，目錄結構和核心 API 的簡要描述極其重要，能讓 AI 快速建立代碼庫的心理地圖，避免重複解析大量檔案。

#### ❌ 不應該提取
- 具體的程式碼實作細節
- 環境設定問題
- IDE 相關問題
- 版本控制流程

### 提取來源

```
對話歷史
├── 模組討論
│   └─> "這個目錄用來做..." → 用途記錄
│
├── 設計討論
│   └─> "為什麼選擇 A 而不是 B" → 決策記錄
│
├── 實作過程
│   └─> "注意要處理這個邊界條件" → 重要細節
│
└── 問題解決
    └─> "這裡容易出錯，需要..." → 陷阱記錄
```

---

## 🏗️ 實作設計

### 整體架構

```
┌─────────────────────────────────────────────────┐
│              /lessons 命令流程                   │
├─────────────────────────────────────────────────┤
│                                                  │
│  1. 掃描對話歷史                                 │
│     └─> 提取與該目錄相關的對話                   │
│                                                  │
│  2. 識別關鍵資訊                               │
│     ├─> 模組用途                                 │
│     ├─> 設計決策                                 │
│     ├─> 實作細節                                 │
│     └─> 模組關係                                 │
│                                                  │
│  3. 提取知識精華                                │
│     ├─> 去除重複內容                             │
│     ├─> 關聯相關概念                             │
│     └─> 結構化整理                               │
│                                                  │
│  4. 生成 CLAUDE.md                               │
│     ├─> 讀取現有內容                             │
│     ├─> 合併新知識                               │
│     ├─> 保持簡潔                                 │
│     └─> 寫入檔案                                 │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 目錄結構

```
專案根目錄/
├── CLAUDE.md                    # 全域知識
├── watchlist/
│   ├── CLAUDE.md                # watchlist 模組精隨
│   ├── generator.py
│   └── actor.py
├── finml/datacore/
│   ├── CLAUDE.md                # datacore 模組精隨
│   └── api.py
└── tests/
    ├── CLAUDE.md                # 測試模組精隨
    └── test_*.py
```

---

## 🔧 命令介面設計

### 基本用法

```bash
# 1. 掃描當前目錄，生成 CLAUDE.md
/lessons

# 2. 掃描指定目錄
/lessons watchlist/
/lessons finml/datacore/

# 3. 預覽模式（不寫入，只顯示）
/lessons --dry-run

# 4. 指定對話範圍
/lessons --last 20           # 最近 20 次對話
/lessons --since "2024-01-01"  # 指定日期之後
```

### 輸出範例

```
🔍 分析 watchlist/ 目錄的對話歷史...
   找到 15 則相關對話

📊 提取知識精華中...
   ✓ 模組用途：股票觀察清單管理
   ✓ 設計決策：使用 Actor 模式
   ✓ 重要細節：事件發布機制
   ✓ 模組關係：依賴 datacore 和 notification

💾 生成 CLAUDE.md...
   ✓ watchlist/CLAUDE.md 已更新

✅ 完成！提取了 4 項核心知識。
```

---

## 📄 CLAUDE.md 模板結構

### 標準模板

```markdown
# {目錄名稱} - {簡短描述}

## 🎯 模組用途
用來做什麼？核心功能是什麼？

## 🏗️ 核心設計
關鍵的架構選擇和設計模式。

## ⚠️ 重要注意事項
實作時需要特別注意的地方。

## 🔗 相關模組
跟其他模組的依賴關係和互動方式。
```

### 範例

```markdown
# watchlist/ - 股票觀察清單模組

## 🎯 模組用途
用於管理和監控股票觀察清單，支援自動檢查股價變化和通知。

## 📁 目錄結構
```
watchlist/
├── __init__.py              # 模組初始化
├── manager.py              # WatchlistManager (核心管理類)
├── monitor.py              # PriceMonitor (價格監控類)
├── notifier.py             # NotificationSender (通知發送類)
└── config/                 # 配置檔案目錄
    └── default.yaml        # 預設觀察清單配置
```

## 🔧 核心 API/Class
- **WatchlistManager**: 主要管理類，負責觀察清單的 CRUD 操作
- **PriceMonitor**: 價格監控引擎，定期檢查股價變化
- **NotificationSender**: 通知發送器，整合多種通知渠道
- **MessageBus**: 事件總線，處理模組間異步通訊

## 🏗️ 核心設計
- 使用 Actor 模式處理非同步事件
- Polars 處理大量股票資料
- MessageBus 機制進行模組間通訊

## ⚠️ 重要注意事項
- 事件發布必須透過 MessageBus，不可直接呼叫方法
- MultiIndex 欄位存取要用 tuple 格式
- 定時任務需要考慮執行時間

## 🔗 相關模組
- **datacore**: OHLCV 資料來源
- **notification**: 通知系統
- **config**: 觀察清單配置
```

---

## 🎯 知識提取規則

### 觸發條件

#### 1. 模組用途識別
```
關鍵詞：
- "這個目錄用來"
- "模組的功能是"
- "主要負責"
- "這裡做什麼"

提取：
- 模組的核心目的
- 主要功能描述
- 使用場景
```

#### 2. 設計決策識別
```
關鍵詞：
- "為什麼選擇"
- "決定用"
- "設計原因是"
- "採用這種方式"

提取：
- 設計背景
- 技術選擇理由
- 架構決策
```

#### 3. 重要細節識別
```
關鍵詞：
- "要注意"
- "特別處理"
- "不要忘記"
- "這裡容易錯"

提取：
- 實作細節
- 邊界條件
- 常見錯誤
```

#### 4. 模組關係識別
```
關鍵詞：
- "依賴"
- "調用"
- "跟...互動"
- "需要...支援"

提取：
- 依賴關係
- 介面定義
- 資料流向
```

### 去重邏輯

```python
def is_duplicate(new_knowledge, existing_knowledge):
    """
    判斷是否為重複知識

    合併策略：
    - 相同概念保留更詳細的描述
    - 互補資訊進行合併
    - 過時資訊標記更新
    """
    pass
```

---

## 🔄 更新策略

### 合併規則

1. **新增知識**: 直接添加到對應分類
2. **更新知識**:
   - 如果更詳細，替換舊版本
   - 如果補充資訊，合併內容
3. **刪除知識**:
   - 過時的資訊（標記為已過時）
   - 重複內容（保留較好的版本）

---

> 💡 **設計哲學**: 讓對話中的程式碼精華自動沉澱為模組說明書，AI 下次遇到這個目錄時，讀 CLAUDE.md 就能快速理解「這裡做什麼、怎麼做的、要注意什麼」，而不需要讀取所有程式碼。

> 🤖 **AI 導航價值**: 包含目錄結構和核心 API 描述的 CLAUDE.md 對 AI 協作開發極具價值，如同為 AI 提供了精確的地圖和詞彙表，大幅提升理解效率和準確性。
# Gap Analysis Command - 系統重寫差異分析專用指南

為量化交易專案執行 **Gap Analysis**，專門處理**舊系統完全廢棄 + 新系統重寫**的場景。

**🚨 重要**: Gap Analysis 與傳統 SA 分析完全不同，不需要 DFD/ERD/Call Stack 深度追蹤，專注於功能差異識別與優先級評估。

## 🎯 Gap Analysis 適用場景

### **何時使用 Gap Analysis？**

**核心判斷標準**：
- ✅ **舊系統完全廢棄**：舊系統將不再使用，無需保留架構
- ✅ **新系統已有架構**：新系統架構已確定（如新的 Pipeline 架構）
- ✅ **重點是功能對映**：需要識別新舊系統的功能差異

**典型場景**：
- 舊技術棧完全淘汰（如從某框架遷移到獨立架構）
- 新架構模式已確定（如從單一類別改為 Component-based）
- 需要評估「舊系統有什麼功能」vs「新系統缺少什麼」

### **何時不用 Gap Analysis？**

❌ **使用傳統 SA** 的場景：
- 舊系統需要深度理解（重構而非重寫）
- 新功能開發需要利用現有 codebase
- 需要詳細的 Call Stack 和數據流分析

---

## 🔄 Gap Analysis vs 傳統 SA 對比

| 維度 | 傳統 SA 分析 | Gap Analysis |
|------|-------------|--------------|
| **目標** | 深度理解系統架構 | 功能差異識別 |
| **舊系統分析** | 深度 Call Stack 追蹤 | 快速功能盤點（不做深度分析） |
| **新系統分析** | 設計新架構 | 盤點已完成功能 |
| **DFD 數據流圖** | ✅ 必要 | ❌ 不需要 |
| **ERD 實體關係圖** | ✅ 必要 | ❌ 不需要 |
| **狀態轉換圖** | ✅ 必要 | ❌ 通常不需要 |
| **Call Stack 追蹤** | ✅ 深度追蹤 | ❌ 不需要 |
| **核心產出** | Context/DFD/ERD/狀態圖 | 功能矩陣、Gap 評估、優先級 |
| **文檔結構** | Analysis & Design 傳統結構 | Gap Analysis 專用結構 |

---

## 📚 專業知識庫 (強制自動載入)

🚨 **必須按順序載入以下核心文檔：**
1. CLAUDE.md - 基礎行為準則與環境約束
2. docs/plans/session_notes.md - 當前任務狀態
3. docs/ai_support/core/architect_comprehensive_guide.md - 架構分析指導

---

## 🔍 Gap Analysis 核心方法論

### **分析策略：功能對映與差異識別**

**核心流程**：
```
新系統功能盤點 → 舊系統功能盤點 → Gap 識別對映 → 功能價值評估 → 優先級排序
```

#### **1. 新系統功能盤點**
**目標**: 詳細列舉新系統已完成的功能與架構特色

**盤點重點**：
- ✅ 新系統架構模式（如 Pipeline-based, Component-based）
- ✅ 已實現的核心功能清單
- ✅ API 使用方式和技術棧特色
- ✅ 架構優勢識別（如框架獨立性、模組化設計）

**不需要**：
- ❌ 設計新架構（架構已確定）
- ❌ 繪製 DFD/ERD（不是設計階段）

#### **2. 舊系統功能盤點**
**目標**: 快速盤點舊系統提供的功能清單

**盤點重點**：
- ✅ 舊系統提供了哪些功能
- ✅ 核心依賴識別（如依賴哪些框架）
- ✅ 關鍵實作檔案（3-5 個最核心）

**明確不做**：
- ❌ 深度 SA 分析（不需要 DFD/ERD）
- ❌ Call Stack 深度追蹤
- ❌ 數據流詳細分析
- ❌ 架構痛點深度挖掘

**查證策略**：
- 只查證 3-5 個核心檔案
- 重點：理解「有什麼功能」，不是「如何實作」
- 避免過度深入細節

#### **3. Gap 識別與對映**
**目標**: 逐一對映新舊功能，識別缺口

**對映方法**：
- 建立功能對映矩陣
- 逐一檢查：舊系統每個功能在新系統的對應狀態
- 分類標記：
  - ✅ **已有對應** - 新系統已實現
  - ⚠️ **部分實現** - 新系統部分覆蓋
  - ❌ **完全缺失** - 新系統未實現

**Gap 分類**：
- **核心 Gap** (P0-P1): 業務必要功能
- **增強 Gap** (P2): 改善功能
- **棄用 Gap**: 舊功能不再需要

#### **4. 功能價值評估**
**目標**: 評估每個 Gap 的業務價值與實作優先級

**評估維度**：
```
業務價值 × 技術複雜度 × 替代方案 = 實作決策
```

**優先級框架**：
- **P0** (核心必要): 無此功能系統無法運作
- **P1** (重要功能): 顯著影響業務價值
- **P2** (增強功能): 錦上添花
- **不做**: 可用替代方案或不再需要

---

## 🚨 Gap Analysis 預查證清單機制

### **查證清單分段設計**

#### **新系統查證清單**
**目標**: 理解新系統已完成的功能與架構

**必查檔案範例**：
- [ ] Pipeline 工廠函數檔案（如 `create_xxx_pipeline.py`）
- [ ] 核心 Component 實作（如主要組件類別）
- [ ] Model/API 檔案（新系統的核心 API）
- [ ] Examples 檔案（使用範例最能說明功能）
- [ ] 實驗執行腳本（完整流程展示）

**查證重點**：
- ✅ 新系統的架構模式
- ✅ 已完成的功能清單
- ✅ API 使用方式
- ✅ 技術棧特色

#### **舊系統查證清單**
**目標**: 快速盤點功能清單，不做深度分析

**必查檔案** (僅 3-5 個核心檔案)：
- [ ] 主要入口檔案（如主要管理器類別）
- [ ] 核心實作檔案（如核心功能類別）
- [ ] 配置檔案（理解功能配置）

**查證重點**：
- ✅ 舊系統提供的功能清單
- ✅ 核心依賴識別
- ❌ **不查證**: Call Stack 深度追蹤
- ❌ **不查證**: 數據流詳細分析

---

## 📊 Gap Analysis 文檔輸出標準

### **🚨 強制要求：單一 Gap Analysis 文檔**

**核心原則**:
- ✅ **必須產出單一文檔**，不得分散成多個文檔
- ✅ **文檔命名**: `[project_name]_gap_analysis.md`
- ✅ **文檔位置**: `docs/analysis/` 目錄
- ❌ **禁止產出**: 多個分散的功能清單、矩陣、評估表文檔

**執行彈性**:
- ⚠️ **允許中介文檔**: 分析過程中可產出中介文檔幫助組織思路
- ✅ **最終必須整合**: 最後必須整合所有中介文檔為單一 Gap Analysis 文檔
- ✅ **清理中介文檔**: 整合完成後刪除中介文檔，保持文檔管理清晰

---

### **Gap Analysis 文檔標準結構**

```markdown
# [Project Name] - Gap Analysis 完整分析

**分析日期**: YYYY-MM-DD
**分析類型**: Gap Analysis（舊系統廢棄 + 新系統重寫）
**分析範圍**: [簡述舊系統和新系統]

---

## Executive Summary

### 分析目標
[1-2 句話說明為什麼做 Gap Analysis]

### 核心發現
- 新系統已實現功能：XX/YY (XX%)
- 識別 Gap 總數：ZZ 個
  - 核心 Gap (P0-P1)：NN 個
  - 增強 Gap (P2)：MM 個
  - 棄用功能：KK 個

### 整體統計
[表格或圖表展示整體 Gap 分布]

---

## Part 1: 新系統功能盤點

### 1.1 新架構核心設計
- **架構模式**: [如 Pipeline-based, Component-based]
- **核心特色**: [如框架獨立、模組化設計]
- **技術棧**: [主要技術選型]

### 1.2 新系統已實現功能
[分類列舉已完成功能]

**分類 1: [功能類別名稱]**
- ✅ 功能 A - 簡述
- ✅ 功能 B - 簡述

**分類 2: [功能類別名稱]**
- ✅ 功能 C - 簡述

### 1.3 新系統技術棧總結
[表格總結技術棧]

---

## Part 2: 舊系統功能盤點

### 2.1 分析範圍
- **核心模組**: [列出分析的主要模組]
- **核心檔案**: [列出 3-5 個關鍵檔案]
- **排除範圍**: [明確不分析的部分]

### 2.2 核心依賴鏈
- **框架依賴**: [如依賴的主要框架]
- **關鍵組件**: [核心實作組件]

### 2.3 功能統計
[總覽舊系統功能數量和分類]

### 2.4 舊系統核心流程
[不需要 DFD，只需簡單文字描述核心流程]

**流程 1: [流程名稱]**
- 步驟 1 → 步驟 2 → 步驟 3

---

## Part 3: Gap Analysis 矩陣

### 3.1 數據準備功能
| 舊系統功能 | 新系統對應 | Gap 狀態 | 優先級 |
|-----------|-----------|---------|--------|
| 功能 A | ✅ 已實現 | - | - |
| 功能 B | ❌ 缺失 | Gap-001 | P0 |
| 功能 C | ⚠️ 部分實現 | Gap-002 | P1 |

### 3.2 模型訓練功能
[同上格式]

### 3.3 策略回測功能
[同上格式]

### 3.4 績效分析功能
[同上格式]

### 3.5 其他功能
[同上格式]

---

### Gap 統計總覽
| Gap 類型 | 數量 | 佔比 |
|---------|------|------|
| 核心 Gap (P0-P1) | XX | YY% |
| 增強 Gap (P2) | XX | YY% |
| 棄用功能 | XX | YY% |
| **總計** | **ZZ** | **100%** |

---

## Part 4: 功能價值評估

### 4.1 評估標準
**評估維度**:
- **業務價值**: 高/中/低
- **技術複雜度**: 高/中/低
- **替代方案**: 有/無

**決策矩陣**:
```
業務價值 (高) × 技術複雜度 (低) = P0 優先實作
業務價值 (高) × 技術複雜度 (高) = P1 重要但複雜
業務價值 (低) × 有替代方案 = 不做
```

### 4.2 決策矩陣

| Gap ID | 功能名稱 | 業務價值 | 技術複雜度 | 替代方案 | 決策 |
|--------|---------|---------|-----------|---------|------|
| Gap-001 | 功能 A | 高 | 低 | 無 | P0 實作 |
| Gap-002 | 功能 B | 高 | 高 | 無 | P1 實作 |
| Gap-003 | 功能 C | 低 | 中 | 有 | 不做 |

### 4.3 優先級分布
[圖表或表格展示 P0/P1/P2 分布]

---

## Part 5: SA 分析總結

### 5.1 系統理解總結
- **新系統優勢**: [列出核心優勢]
- **舊系統限制**: [列出主要限制]
- **架構演進**: [新舊系統架構差異]

### 5.2 核心發現
1. **發現 1**: [重要發現]
2. **發現 2**: [重要發現]

### 5.3 技術可行性評估
- **P0-P1 Gap 可行性**: [評估核心 Gap 的實作可行性]
- **技術風險**: [識別潛在風險]
- **依賴關係**: [識別實作依賴]

### 5.4 Phase 2 設計基礎
**為 SD 設計提供的關鍵資訊**:
- Gap 優先級排序（P0-P1 核心 Gap）
- 新系統架構基礎
- 可重用的舊系統邏輯（保留驗證過的業務邏輯）

---

## 附錄: 詳細功能清單

### A. 新系統功能詳細清單
[完整列舉所有已實現功能]

### B. 舊系統功能詳細清單
[完整列舉所有舊功能]

### C. 完整 Gap 清單
[按優先級排序的完整 Gap 列表]
```

---

## 🔄 Gap Analysis 分段執行指導

### **🚨 Gap Analysis 分段執行要求**

**禁止一次完成整個 Gap Analysis，必須分段進行並通過 Review:**

#### **段落 1: 新系統功能盤點**
- **🎯 目標**: 詳細列舉新系統已完成的功能與架構
- **📋 交付**: 新系統功能清單 + 技術棧總結 + 架構特色
- **🔍 USER REVIEW**: 新系統理解正確性，功能盤點完整性
- **⚠️ 必須 Review 通過才能進入段落 2**

#### **段落 2: 舊系統功能盤點**
- **🎯 目標**: 快速盤點舊系統提供的功能（不做深度分析）
- **📋 交付**: 舊系統功能清單 + 核心依賴識別
- **🔍 USER REVIEW**: 功能盤點完整性，是否遺漏重要功能
- **⚠️ 必須 Review 通過才能進入段落 3**

#### **段落 3: Gap Analysis 矩陣**
- **🎯 目標**: 逐一對映新舊功能，識別 Gap
- **📋 交付**: Gap 分析矩陣 + Gap 分類 + 統計總覽
- **🔍 USER REVIEW**: Gap 識別準確性，對映邏輯合理性
- **⚠️ 必須 Review 通過才能進入段落 4**

#### **段落 4: 功能價值評估**
- **🎯 目標**: 評估每個 Gap 的業務價值與實作優先級
- **📋 交付**: 價值評估表 + 優先級排序 + 決策建議
- **🔍 USER REVIEW**: 優先級評估合理性，決策建議可行性
- **✅ Gap Analysis 完成標準**: 所有 4 個段落 Review 通過

---

## 🚨 專案特定約束模板

### **Gap Analysis 專用約束範例**
> **注意**: 以下約束需要根據實際專案的 CLAUDE.md 進行客製化

- **驗證策略**: 定義專案的驗證機制（如：assert 優先原則）
- **實際代碼優先**: 所有分析基於實際代碼查證，禁止經驗推測
- **來源標記要求**: 每個分析結論必須標註檔案來源和代碼特徵
- **批量查證機制**: 預查證清單確認後批量讀取，優化 context 使用
- **避免過度分析**: 舊系統不做深度 Call Stack 追蹤和數據流分析

### **Mermaid 圖表規範**
- **Dark Theme 相容**: 避免純白色背景，確保 dark theme 可讀性
- **推薦圖表類型**:
  - 功能對映矩陣: Markdown 表格（不用 mermaid）
  - 優先級分布: `pie chart` 或表格
  - 架構總覽: `graph TD/LR`（僅在必要時）

---

## 📋 Gap Analysis 品質檢查

### **分析完整性**
- [ ] 新系統功能盤點完整且準確
- [ ] 舊系統功能盤點涵蓋核心功能（3-5 個核心檔案）
- [ ] Gap 矩陣逐一對映，無遺漏
- [ ] 優先級評估有明確依據（業務價值 × 技術複雜度）
- [ ] 產出單一 Gap Analysis 文檔（整合所有中介文檔）

### **分段執行可行性**
- [ ] 4 個段落劃分合理且相對獨立
- [ ] 每個段落有明確的目標和交付物
- [ ] Review 檢查點設計清晰可執行
- [ ] 段落間的依賴關係明確

### **避免過度分析**
- [ ] 舊系統未做深度 Call Stack 追蹤
- [ ] 舊系統未繪製 DFD/ERD
- [ ] 聚焦於「功能差異」而非「架構細節」

---

## 🔧 輸出和後續行動

### **Gap Analysis 完成後**

1. **確認產出單一文檔**: `[project_name]_gap_analysis.md`
2. **刪除所有中介文檔**: 保持文檔管理清晰
3. **提供 Gap 統計總覽**: P0-P1 核心 Gap 數量和優先級

### **後續行動建議**
- **進入 Phase 2**: 使用 `/design-plan` 規劃 SD 設計
- **基於 Gap 設計**: SD 設計聚焦於填補 P0-P1 核心 Gap
- **重用舊邏輯**: 識別舊系統中已驗證的業務邏輯，在新系統中重用

### **session_notes 更新**
- 記錄 Gap Analysis 核心發現
- 更新 P0-P1 核心 Gap 清單
- 記錄技術可行性評估結果

---

## 🎯 實戰參考範例

### **典型系統重寫場景**
**場景描述**: 從舊框架系統遷移到新 Pipeline 架構
- **新系統**: 26/67 功能已實現 (39%)
- **Gap 總數**: 38 個
  - P0-P1 核心 Gap: 18 個
  - 兩大核心缺口：策略回測系統、績效分析系統
- **文檔產出**: `[project]_gap_analysis.md`

**關鍵經驗**:
1. 新系統功能盤點：通過 examples 快速理解架構
2. 舊系統功能盤點：只查證核心檔案，避免深入
3. Gap 矩陣：功能逐一對映，清晰識別缺口
4. 優先級評估：P0-P1 核心 Gap 優先設計實作

---

**重要**: Gap Analysis 專注於功能差異識別，不做深度系統分析。如需深度理解系統架構，請使用傳統 SA 分析（`/analysis-plan`）。
